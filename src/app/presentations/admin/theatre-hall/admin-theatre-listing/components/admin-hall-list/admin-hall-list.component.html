<!-- Hall Management Modal -->
<p-toast position="top-right"></p-toast>
<!-- <p-confirmPopup></p-confirmPopup> -->

<div class="hall-list-container">
	<!-- Header Section -->
	<div class="header-section">
		<div class="theatre-info">
			<h2 class="theatre-name">{{ theatre.name }}</h2>
			<p class="theatre-details">
				<i class="pi pi-map-marker mr-2"></i>
				{{ theatre.address }}
			</p>
			<div class="theatre-stats">
				<p-tag [value]="halls.length + ' Halls'" severity="info" class="mr-2">
				</p-tag>
				<p-tag [value]="getTotalCapacity() + ' Total Seats'" severity="success">
				</p-tag>
			</div>
		</div>

		<div class="header-actions">
			<p-button
				label="Add New Hall"
				icon="pi pi-plus"
				severity="primary"
				(onClick)="onAddHall()"
				[disabled]="loading"
			></p-button>
		</div>
	</div>

	<!-- Loading State -->
	<div class="loading-section" *ngIf="loading">
		<div class="flex justify-center items-center py-8">
			<div class="text-center">
				<p-progressBar mode="indeterminate" styleClass="mb-4"></p-progressBar>
				<p class="text-slate-600">Loading...</p>
			</div>
		</div>
	</div>

	<!-- Empty State -->
	<div class="empty-state" *ngIf="!loading && halls.length === 0">
		<div class="text-center py-12">
			<i class="pi pi-home text-6xl text-gray-400 mb-4"></i>
			<h3 class="text-xl font-semibold text-gray-700 mb-2">No Halls Found</h3>
			<p class="text-gray-500 mb-6">
				This theatre doesn't have any halls yet. Add the first hall to get
				started.
			</p>
			<p-button
				label="Add First Hall"
				icon="pi pi-plus"
				severity="primary"
				(onClick)="onAddHall()"
			></p-button>
		</div>
	</div>

	<!-- Halls TabView -->
	<div class="halls-tabview" *ngIf="!loading && halls.length > 0">
		<p-tabView>
			<p-tabPanel
				*ngFor="let hall of halls; trackBy: trackByHallId"
				[header]="hall.name + ' (' + hall.capacity + ' seats)'"
			>
				<div class="hall-panel-content">
					<!-- Hall Header -->
					<div class="hall-header">
						<div class="hall-title">
							<h3>{{ hall.name }}</h3>
							<p-tag
								[value]="hall.capacity + ' seats'"
								[severity]="getHallStatusSeverity(hall.capacity)"
							>
							</p-tag>
						</div>

						<div class="hall-actions">
							<p-button
								icon="pi pi-pencil"
								severity="secondary"
								size="small"
								[text]="true"
								(onClick)="onEditHall(hall)"
								pTooltip="Edit Hall"
							></p-button>

							<p-button
								icon="pi pi-trash"
								severity="danger"
								size="small"
								[text]="true"
								(onClick)="onDeleteHall(hall, $event)"
								pTooltip="Delete Hall"
							></p-button>
						</div>
					</div>

					<!-- Hall Details -->
					<div class="hall-details">
						<div class="detail-row" *ngIf="hall.description">
							<span class="detail-label">Description:</span>
							<span class="detail-value">{{ hall.description }}</span>
						</div>
						<div class="detail-row">
							<span class="detail-label">Layout:</span>
							<span class="detail-value"
								>{{ hall.rows }} rows × {{ hall.columns }} columns</span
							>
						</div>
						<div class="detail-row">
							<span class="detail-label">Screen:</span>
							<span class="detail-value">
								Position {{ hall.screenStart }}-{{
									hall.screenStart + hall.screenSpan - 1
								}}
								({{ hall.screenSpan }} columns wide)
							</span>
						</div>
					</div>

					<div>
						<div class="flex justify-between border-b border-gray-200 mb-2">
							<p>Seat Categories & Management</p>
							<div class="flex gap-2">
								<p-button
									icon="pi pi-chair"
									label="Add Seats"
									size="small"
									severity="info"
									[outlined]="true"
									(onClick)="openAddSeatDialog(hall)"
									pTooltip="Add Seats to Hall"
								></p-button>
								<p-button
									icon="pi pi-plus"
									label="Seat Category"
									size="small"
									[outlined]="true"
									(onClick)="openAddSeatCategoryDialog(hall)"
									pTooltip="Add Seat Category"
								></p-button>
							</div>
						</div>

						<div class="flex flex-col gap-3">
							<div
								*ngFor="let item of hall.seatCategories"
								class="flex gap-2 items-center justify-between p-3 border border-gray-200 dark:border-gray-600 rounded-lg"
							>
								<div class="flex gap-2 items-center">
									<div
										class="w-12 h-12 rounded-t-xl border-2 border-white shadow-sm"
										[class]="item.baseColorHexCode"
									></div>
									<div>
										<p
											class="font-medium p-0 m-0 text-gray-900 dark:text-white"
										>
											{{ item.name }}
										</p>
										<p class="text-sm p-0 m-0 text-gray-600 dark:text-gray-400">
											{{ item.description }}
										</p>
										<p class="text-xs text-gray-500 dark:text-gray-400">
											Class: {{ item.baseColorHexCode }}
										</p>
									</div>
								</div>
								<div class="flex gap-1">
									<p-button
										icon="pi pi-pencil"
										severity="secondary"
										size="small"
										[text]="true"
										(onClick)="openEditSeatCategoryDialog(item)"
										pTooltip="Edit Seat Category"
									></p-button>
									<p-button
										icon="pi pi-trash"
										severity="danger"
										size="small"
										[text]="true"
										(onClick)="deleteSeatCategory(item, $event)"
										pTooltip="Delete Seat Category"
									></p-button>
								</div>
							</div>
						</div>
					</div>

					<!-- Hall Layout Preview -->
					<div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mt-4">
						<h4
							class="text-sm font-medium text-gray-800 dark:text-gray-200 mb-3 flex items-center gap-2"
						>
							<i class="pi pi-eye text-blue-600"></i>
							Hall Layout Preview
							<p-tag
								[value]="getHallSeats(hall).length + ' seats created'"
								severity="info"
								class="ml-2"
							></p-tag>
						</h4>

						<div
							class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-600"
						>
							<!-- Screen Section -->
							<div class="mb-4">
								<!-- Screen positioned within the same grid as seats -->
								<div class="flex items-center gap-2">
									<!-- Empty space for row label -->
									<div class="w-8"></div>

									<!-- Screen Grid Container -->
									<div class="flex gap-1 flex-1 justify-center">
										<div
											*ngFor="
												let col of Array(hall.columns).fill(0);
												let colIndex = index
											"
											class="w-6 h-6 flex items-center justify-center"
										>
											<!-- Screen spans across specified columns -->
											<div
												*ngIf="
													colIndex >= hall.screenStart - 1 &&
													colIndex < hall.screenStart - 1 + hall.screenSpan
												"
												class="w-full h-3 bg-primary-800 dark:bg-primary-900 text-white text-xs flex items-center justify-center font-semibold"
												[class.rounded-l-md]="colIndex === hall.screenStart - 1"
												[class.rounded-r-md]="
													colIndex ===
													hall.screenStart - 1 + hall.screenSpan - 1
												"
											>
												SCREEN
											</div>
										</div>
									</div>
								</div>
							</div>

							<!-- Seating Layout -->
							<div class="space-y-1 mt-3">
								<!-- Row Labels and Seats -->
								<div
									*ngFor="
										let row of Array(hall.rows).fill(0);
										let rowIndex = index
									"
									class="flex items-center gap-2"
								>
									<!-- Row Label -->
									<div
										class="w-8 text-sm font-medium text-gray-600 dark:text-gray-400 text-center"
									>
										{{ String.fromCharCode(65 + rowIndex) }}
									</div>

									<!-- Seats in Row -->
									<div class="flex gap-1 flex-1 justify-center">
										<div
											*ngFor="
												let seat of Array(hall.columns).fill(0);
												let colIndex = index
											"
											class="w-8 h-8 rounded-t-lg text-xs font-bold flex items-center justify-center transition-all duration-200 relative"
											[class]="getSeatClass(rowIndex, colIndex, hall)"
											[title]="getSeatTitle(rowIndex, colIndex, hall)"
											[class.shadow-md]="hasSeatAt(rowIndex, colIndex, hall)"
											[class.border-2]="hasSeatAt(rowIndex, colIndex, hall)"
											[class.border-white]="hasSeatAt(rowIndex, colIndex, hall)"
										>
											<!-- Seat Number -->
											<span
												*ngIf="hasSeatAt(rowIndex, colIndex, hall)"
												class="text-black text-2xs font-semibold drop-shadow-sm"
											>
												{{ getSeatNumber(rowIndex, colIndex, hall) }}
											</span>
										</div>
									</div>

									<!-- Row Label (Right) -->
									<div
										class="w-8 text-sm font-medium text-gray-600 dark:text-gray-400 text-center"
									>
										{{ String.fromCharCode(65 + rowIndex) }}
									</div>
								</div>
							</div>

							<!-- Column Numbers at Bottom -->
							<div class="flex items-center gap-2 mt-2">
								<!-- Empty space for row label -->
								<div class="w-8"></div>

								<!-- Column Numbers -->
								<div class="flex gap-1 flex-1 justify-center">
									<div
										*ngFor="
											let col of Array(hall.columns).fill(0);
											let colIndex = index
										"
										class="w-6 text-xs font-medium text-gray-500 dark:text-gray-400 text-center"
									>
										{{ colIndex + 1 }}
									</div>
								</div>

								<!-- Empty space for right row label -->
								<div class="w-8"></div>
							</div>

							<!-- Legend and Seat Categories -->
							<div
								class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-600"
							>
								<!-- Seat Categories Legend -->
								<div
									class="mb-3"
									*ngIf="hall.seatCategories && hall.seatCategories.length > 0"
								>
									<h5
										class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2"
									>
										Seat Categories:
									</h5>
									<div class="flex flex-wrap items-center gap-3 text-xs">
										<div
											*ngFor="let category of hall.seatCategories"
											class="flex items-center gap-2"
										>
											<div
												class="w-4 h-4 rounded-t-md border border-white shadow-sm"
												[class]="category.baseColorHexCode"
											></div>
											<span class="text-gray-600 dark:text-gray-400">
												{{ category.name }}
												<span class="text-gray-500">
													({{
														getSeatsCountByCategory(hall).get(category.name) ||
															0
													}})
												</span>
											</span>
										</div>
									</div>
								</div>

								<!-- General Legend -->
								<div class="flex items-center justify-center gap-4 text-xs">
									<div class="flex items-center gap-1">
										<div
											class="w-4 h-4 bg-gray-200 dark:bg-gray-700 border border-gray-300 rounded-t-md"
										></div>
										<span class="text-gray-600 dark:text-gray-400"
											>Empty Position</span
										>
									</div>
								</div>
							</div>

							<!-- Layout Statistics -->
							<div
								class="mt-3 text-xs text-gray-500 dark:text-gray-400 text-center space-y-1"
							>
								<div>
									{{ hall.rows }} rows × {{ hall.columns }} columns =
									{{ hall.capacity }} total positions
								</div>
								<div class="font-medium text-blue-600 dark:text-blue-400">
									{{ getHallSeats(hall).length }} seats created out of
									{{ hall.capacity }} positions
								</div>
							</div>
						</div>
					</div>

					<!-- Hall Stats -->
					<div class="hall-stats">
						<div class="stat-item">
							<span class="stat-label">Capacity</span>
							<span class="stat-value">{{ hall.capacity }}</span>
						</div>
						<div class="stat-item">
							<span class="stat-label">Rows</span>
							<span class="stat-value">{{ hall.rows }}</span>
						</div>
						<div class="stat-item">
							<span class="stat-label">Columns</span>
							<span class="stat-value">{{ hall.columns }}</span>
						</div>
					</div>
				</div>
			</p-tabPanel>
		</p-tabView>
	</div>
</div>
