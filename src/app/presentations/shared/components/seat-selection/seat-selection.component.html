<div class="seat-selection-booking-container">
	<!-- Common Header with Movie and Screening Information -->
	<div class="mb-6 p-6 shadow-lg">
		<div>
			<p class="text-xl text-gray-600 mb-1">Session: {{ sessionId }}</p>
		</div>
		<div class="flex items-start justify-between">
			<!-- Session Details -->

			<!-- Movie and Screening Details -->
			<div class="flex-1">
				<h2 class="text-2xl font-bold mb-3">{{ screening.movie.name }}</h2>
				<div
					class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm"
				>
					<div>
						<p class="mb-1">Date</p>
						<p class="font-medium">{{ screening.date | date : "shortDate" }}</p>
					</div>
					<div>
						<p class="mb-1">Time</p>
						<p class="font-medium">
							{{ screening.startTime }} - {{ screening.endTime }}
						</p>
					</div>
					<div>
						<p class="mb-1">Theatre</p>
						<p class="font-medium">{{ screening.hall.theatre.name }}</p>
					</div>
					<div>
						<p class="mb-1">Hall</p>
						<p class="font-medium">{{ screening.hall.name }}</p>
					</div>
				</div>
			</div>

			<!-- Selected Seats Summary -->
			<div class="ml-6 text-right" *ngIf="selectedSeats.length > 0">
				<p class="text-blue-200 mb-2">Selected Seats</p>
				<div class="flex flex-wrap justify-end gap-2 mb-2">
					<span
						*ngFor="let seat of selectedSeats"
						class="px-3 py-1 bg-white bg-opacity-20 rounded-full text-sm font-medium"
					>
						{{ seat.seatNumber }}
					</span>
				</div>
				<p class="text-xl font-bold">{{ formatCurrency(getTotalAmount()) }}</p>
			</div>
		</div>
	</div>

	<!-- Step Indicator -->
	<div class="mb-6 flex justify-center">
		<div class="flex items-center space-x-4">
			<div class="flex items-center">
				<div
					class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium"
					[class.bg-blue-600]="bookingStep === 'seat-selection'"
					[class.text-white]="bookingStep === 'seat-selection'"
					[class.bg-green-600]="bookingStep !== 'seat-selection'"
					[class.text-white]="bookingStep !== 'seat-selection'"
				>
					1
				</div>
				<span class="ml-2 text-sm font-medium">Select Seats</span>
			</div>
			<div class="w-8 h-0.5 bg-gray-300"></div>
			<div class="flex items-center">
				<div
					class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium"
					[class.bg-blue-600]="bookingStep === 'customer-details'"
					[class.text-white]="bookingStep === 'customer-details'"
					[class.bg-green-600]="bookingStep === 'e-ticket'"
					[class.text-white]="bookingStep === 'e-ticket'"
					[class.bg-gray-300]="bookingStep === 'seat-selection'"
					[class.text-gray-600]="bookingStep === 'seat-selection'"
				>
					2
				</div>
				<span class="ml-2 text-sm font-medium">Customer Details</span>
			</div>
			<div class="w-8 h-0.5 bg-gray-300"></div>
			<div class="flex items-center">
				<div
					class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium"
					[class.bg-green-600]="bookingStep === 'e-ticket'"
					[class.text-white]="bookingStep === 'e-ticket'"
					[class.bg-gray-300]="bookingStep !== 'e-ticket'"
					[class.text-gray-600]="bookingStep !== 'e-ticket'"
				>
					3
				</div>
				<span class="ml-2 text-sm font-medium">E-Ticket</span>
			</div>
		</div>
	</div>

	<!-- Step 1: Seat Selection -->
	<div *ngIf="bookingStep === 'seat-selection'">
		<!-- Loading State -->
		<div *ngIf="loadingSeats" class="flex justify-center items-center py-16">
			<p-progressSpinner strokeWidth="3"></p-progressSpinner>
			<span class="ml-3 text-gray-600">Loading seats...</span>
		</div>

		<!-- Main Layout: Single Column for Seats -->
		<div *ngIf="!loadingSeats && hall" class="pb-32">
			<!-- Add bottom padding for floating panel -->
			<!-- Seat Layout - Full width -->
			<div class="w-full">
				<div class="sticky bg-white top-[5rem] z-30">
					<div class="container mx-auto px-4 py-4">
						<!-- Simple Summary View -->
						<div class="flex items-center justify-between">
							<div class="flex items-center gap-4">
								<p>Seats Selected</p>
								<div class="flex items-center gap-2">
									<div
										class="bg-blue-600 text-white text-sm px-3 py-1 rounded-full font-medium"
										*ngFor="let seat of selectedSeats"
									>
										{{ seat.seatNumber }}
									</div>
								</div>
								<div class="text-right">
									<div class="font-bold text-lg">
										Nu. {{ getTotalAmount() }}
									</div>
									<div class="text-gray-400 text-xs">Total Amount</div>
								</div>
							</div>

							<div class="flex items-center gap-3">
								<button
									type="button"
									class="px-6 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors"
									(click)="proceedToCustomerDetails()"
								>
									Continue to Customer Details
									<i class="pi pi-arrow-right ml-2"></i>
								</button>
							</div>
						</div>
					</div>
				</div>
				<div class="bg-gray-800 rounded-lg p-6">
					<div class="overflow-x-auto">
						<div class="min-w-full flex flex-col items-center justify-center">
							<!-- Legend -->
							<div class="flex flex-wrap justify-center gap-4 mb-8 text-sm">
								<!-- Status Legend -->
								<div class="flex items-center space-x-2">
									<div
										class="w-10 h-10 rounded-lg"
										[ngStyle]="getSelectedLegendStyles()"
									></div>
									<span class="text-white">Selected</span>
								</div>
								<div class="flex items-center space-x-2">
									<div
										class="w-10 h-10 rounded-lg"
										[ngStyle]="getOccupiedLegendStyles()"
									></div>
									<span class="text-white">Occupied</span>
								</div>

								<!-- Seat Categories -->
								<div
									*ngFor="let category of seatCategories"
									class="flex items-center space-x-2"
								>
									<div
										class="w-10 h-10 rounded-lg"
										[ngStyle]="
											getCategoryLegendStyles(category.baseColorHexCode)
										"
									></div>
									<span class="text-white">{{ category.name }}</span>
								</div>
							</div>

							<!-- Seat Rows -->
							<div>
								<div
									*ngFor="let rowIndex of getRows()"
									class="flex items-center"
								>
									<!-- Row Label -->
									<div
										class="w-14 h-14 flex items-center justify-center text-white font-bold bg-gray-800 sticky left-0 z-10"
									>
										{{ getRowLabel(rowIndex) }}
									</div>

									<!-- Seats -->
									<div class="flex ml-2">
										<div
											*ngFor="let colIndex of getColumns()"
											class="w-14 h-14 p-1 rounded-t"
										>
											<div
												*ngIf="
													getSeatAtPosition(rowIndex, colIndex) as seat;
													else emptySeat
												"
												class="w-full h-full rounded-lg cursor-pointer transition-all duration-200 flex items-center justify-center text-xs font-bold"
												[ngStyle]="
													getSeatStyles(seat.category?.baseColorHexCode!, seat)
												"
												(click)="onSeatClick(seat)"
												[title]="
													seat.seatNumber + ' - ' + formatCurrency(seat.price)
												"
											>
												<span class="text-white">{{ seat.seatNumber }}</span>
											</div>
											<ng-template #emptySeat>
												<div class="w-full h-full"></div>
											</ng-template>
										</div>
									</div>
								</div>
							</div>

							<!-- Screen -->
							<div class="flex items-center my-8">
								<div class="w-14 h-14"></div>
								<!-- Empty space for row label -->
								<div class="flex ml-2">
									<div *ngFor="let colIndex of getColumns()" class="w-14 h-14">
										<div
											*ngIf="
												hall &&
												colIndex >= hall.screenStart - 1 &&
												colIndex < hall.screenStart - 1 + hall.screenSpan
											"
											class="w-full h-full border-b-[0.4rem] border-white flex items-center justify-center"
											[class.rounded-l-lg]="colIndex === hall.screenStart - 1"
											[class.rounded-r-lg]="
												colIndex === hall.screenStart - 1 + hall.screenSpan - 1
											"
										>
											<span
												*ngIf="colIndex === getScreenCenter()"
												class="text-white text-xl font-bold"
											>
												Screen
											</span>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Empty State -->
		<div *ngIf="!loadingSeats && !hall" class="text-center py-16">
			<i class="pi pi-th-large text-gray-400 text-6xl mb-4"></i>
			<h3 class="text-lg font-medium text-gray-900 mb-2">
				No Seat Layout Available
			</h3>
			<p class="text-gray-600">
				Unable to load seat layout for this screening.
			</p>
		</div>
	</div>

	<!-- Step 2: Customer Details -->
	<div *ngIf="bookingStep === 'customer-details'" class="max-w-2xl mx-auto">
		<div class="p-6 bg-white rounded-lg border border-gray-200 shadow-sm">
			<h3 class="text-xl font-semibold text-gray-900 mb-6">Customer Details</h3>

			<!-- Customer Form -->
			<form [formGroup]="customerForm" (ngSubmit)="submitCustomerDetails()">
				<div class="space-y-6">
					<div>
						<label
							for="customerName"
							class="block text-sm font-medium text-gray-700 mb-2"
						>
							Customer Name <span class="text-red-500">*</span>
						</label>
						<input
							type="text"
							id="customerName"
							formControlName="customerName"
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
							placeholder="Enter customer name"
						/>
						<div
							*ngIf="
								customerForm.get('customerName')?.invalid &&
								customerForm.get('customerName')?.touched
							"
							class="text-red-500 text-sm mt-1"
						>
							Customer name is required (minimum 2 characters)
						</div>
					</div>

					<div>
						<label
							for="customerPhoneNumber"
							class="block text-sm font-medium text-gray-700 mb-2"
						>
							Phone Number <span class="text-red-500">*</span>
						</label>
						<input
							type="tel"
							id="customerPhoneNumber"
							formControlName="customerPhoneNumber"
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
							placeholder="17123456"
						/>
						<div
							*ngIf="
								customerForm.get('customerPhoneNumber')?.invalid &&
								customerForm.get('customerPhoneNumber')?.touched
							"
							class="text-red-500 text-sm mt-1"
						>
							Valid 8-digit phone number is required
						</div>
					</div>

					<div>
						<label
							for="customerEmail"
							class="block text-sm font-medium text-gray-700 mb-2"
						>
							Email Address (Optional)
						</label>
						<input
							type="email"
							id="customerEmail"
							formControlName="customerEmail"
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
							placeholder="customer@example.com"
						/>
						<div
							*ngIf="
								customerForm.get('customerEmail')?.invalid &&
								customerForm.get('customerEmail')?.touched
							"
							class="text-red-500 text-sm mt-1"
						>
							Please enter a valid email address
						</div>
					</div>

					<div>
						<label
							for="paymentMethod"
							class="block text-sm font-medium text-gray-700 mb-2"
						>
							Payment Method <span class="text-red-500">*</span>
						</label>
						<p-dropdown
							id="paymentMethod"
							formControlName="paymentMethod"
							[options]="paymentMethods"
							placeholder="Select payment method"
							styleClass="w-full"
							[style]="{ width: '100%' }"
						>
						</p-dropdown>
						<div
							*ngIf="
								customerForm.get('paymentMethod')?.invalid &&
								customerForm.get('paymentMethod')?.touched
							"
							class="text-red-500 text-sm mt-1"
						>
							Payment method is required
						</div>
					</div>

					<div>
						<label
							for="notes"
							class="block text-sm font-medium text-gray-700 mb-2"
						>
							Notes
						</label>
						<textarea
							id="notes"
							formControlName="notes"
							rows="3"
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
							placeholder="Any additional notes or special requests..."
						></textarea>
						<div class="text-gray-500 text-xs mt-1">Maximum 500 characters</div>
					</div>
				</div>

				<!-- Form Actions -->
				<div class="mt-8 flex justify-between">
					<button
						type="button"
						class="px-6 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors"
						(click)="backToSeatSelection()"
					>
						<i class="pi pi-arrow-left mr-2"></i>
						Back to Seat Selection
					</button>
					<button
						type="submit"
						class="px-6 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
						[disabled]="bookingLoading"
					>
						<p-progressSpinner
							*ngIf="bookingLoading"
							strokeWidth="3"
							[style]="{ width: '16px', height: '16px' }"
							class="mr-2"
						></p-progressSpinner>
						<span *ngIf="!bookingLoading">Create Booking</span>
						<span *ngIf="bookingLoading">Creating Booking...</span>
					</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Step 3: E-Ticket -->
	<div
		*ngIf="bookingStep === 'e-ticket' && generatedBooking"
		class="max-w-2xl mx-auto"
	>
		<div
			class="p-6 bg-white rounded-lg border border-gray-200 shadow-lg"
			id="ticket-content"
		>
			<div class="text-center mb-6">
				<h2 class="text-2xl font-bold text-green-600 mb-2">
					Booking Successful!
				</h2>
				<p class="text-gray-600">Your e-ticket has been generated</p>
			</div>

			<!-- Ticket Details -->
			<div class="border-2 border-dashed border-gray-300 rounded-lg p-6 mb-6">
				<div class="text-center mb-4">
					<h3 class="text-xl font-bold text-gray-900">
						{{ generatedBooking.screening?.movie?.name }}
					</h3>
					<p class="text-gray-600">
						{{ generatedBooking.screening?.hall?.theatre?.name }}
					</p>
				</div>

				<div class="grid grid-cols-2 gap-4 text-sm">
					<div>
						<p class="font-medium text-gray-700">Booking ID:</p>
						<p class="text-gray-900">{{ generatedBooking.uuid }}</p>
					</div>
					<div>
						<p class="font-medium text-gray-700">Customer:</p>
						<p class="text-gray-900">{{ generatedBooking.name }}</p>
					</div>
					<div>
						<p class="font-medium text-gray-700">Phone:</p>
						<p class="text-gray-900">
							{{ generatedBooking.phoneNumber }}
						</p>
					</div>
					<div>
						<p class="font-medium text-gray-700">Date:</p>
						<p class="text-gray-900">
							{{ generatedBooking.screening?.date | date : "shortDate" }}
						</p>
					</div>
					<div>
						<p class="font-medium text-gray-700">Time:</p>
						<p class="text-gray-900">
							{{ generatedBooking.screening?.startTime }} -
							{{ generatedBooking.screening?.endTime }}
						</p>
					</div>
					<div>
						<p class="font-medium text-gray-700">Hall:</p>
						<p class="text-gray-900">
							{{ generatedBooking.screening?.hall?.name }}
						</p>
					</div>
				</div>

				<div class="mt-4 pt-4 border-t border-gray-200">
					<p class="font-medium text-gray-700 mb-2">Seats:</p>
					<div class="flex flex-wrap gap-2">
						<span
							*ngFor="let seat of generatedBooking.bookingSeats"
							class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium"
						>
							{{ seat.seat?.seatNumber }}
						</span>
					</div>
				</div>

				<div class="mt-4 pt-4 border-t border-gray-200 text-center">
					<div class="grid grid-cols-2 gap-4 text-sm mb-3">
						<div>
							<p class="font-medium text-gray-700">Payment Method:</p>
							<p class="text-gray-900 capitalize">
								{{ generatedBooking.paymentMethod?.toLowerCase() || "Cash" }}
							</p>
						</div>
						<div>
							<p class="font-medium text-gray-700">Total Amount:</p>
							<p class="text-lg font-bold text-gray-900">
								Nu. {{ generatedBooking.amount }}
							</p>
						</div>
					</div>
					<p class="text-sm text-gray-600">
						Status: {{ generatedBooking.bookingStatus }}
					</p>
					<div
						*ngIf="generatedBooking.notes"
						class="mt-3 pt-3 border-t border-gray-200"
					>
						<p class="font-medium text-gray-700 text-sm mb-1">Notes:</p>
						<p class="text-gray-600 text-sm">{{ generatedBooking.notes }}</p>
					</div>
				</div>
			</div>

			<!-- Actions -->
			<div class="flex justify-center space-x-4">
				<button
					type="button"
					class="px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors"
					(click)="printTicket()"
				>
					<i class="pi pi-print mr-2"></i>
					Print Ticket
				</button>
				<button
					type="button"
					class="px-6 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors"
					(click)="startNewBooking()"
				>
					<i class="pi pi-plus mr-2"></i>
					New Booking
				</button>
			</div>
		</div>
	</div>
</div>
