<!-- Admin Create Booking Component -->
<p-toast position="top-right"></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="min-h-screen bg-gray-50 py-6 px-4">
	<div class="max-w-6xl mx-auto">
		<!-- Header -->
		<div class="mb-8">
			<h1 class="text-3xl font-bold text-gray-900 mb-2">Create New Booking</h1>
			<p class="text-gray-600">
				Book tickets for customers through the counter staff interface
			</p>
		</div>

		<!-- Progress Steps -->
		<div class="mb-8">
			<div class="flex items-center justify-between">
				<div
					*ngFor="let step of steps; let i = index"
					class="flex items-center"
					[class.flex-1]="i < steps.length - 1"
				>
					<!-- Step Circle -->
					<div class="flex items-center">
						<div
							class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-semibold transition-all duration-200"
							[ngClass]="{
								'bg-blue-600 text-white': currentStep === step.step,
								'bg-green-600 text-white': step.completed,
								'bg-gray-300 text-gray-600':
									currentStep !== step.step && !step.completed
							}"
						>
							<i *ngIf="step.completed" class="pi pi-check text-sm"></i>
							<span *ngIf="!step.completed">{{ step.step }}</span>
						</div>
						<div class="ml-3">
							<p
								class="text-sm font-medium transition-colors duration-200"
								[ngClass]="{
									'text-blue-600': currentStep === step.step,
									'text-green-600': step.completed,
									'text-gray-500': currentStep !== step.step && !step.completed
								}"
							>
								{{ step.title }}
							</p>
							<p class="text-xs text-gray-500">
								{{ step.description }}
							</p>
						</div>
					</div>

					<!-- Connector Line -->
					<div
						*ngIf="i < steps.length - 1"
						class="flex-1 h-px mx-4 transition-colors duration-200"
						[ngClass]="{
							'bg-green-600': steps[i + 1].completed,
							'bg-gray-300': !steps[i + 1].completed
						}"
					></div>
				</div>
			</div>
		</div>

		<!-- Main Content -->
		<p-card styleClass="shadow-lg border-0 min-h-96">
			<!-- Step 1: Select Screening -->
			<div *ngIf="currentStep === 1" class="space-y-6">
				<div class="flex items-center gap-3 mb-6">
					<div
						class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"
					>
						<i class="pi pi-calendar text-blue-600 text-xl"></i>
					</div>
					<div>
						<h2 class="text-xl font-semibold text-gray-900">
							Select Screening
						</h2>
						<p class="text-gray-600">Choose a movie screening</p>
					</div>
				</div>

				<!-- Search and Filters -->

				<!-- Loading State -->
				<div *ngIf="loading" class="flex justify-center items-center py-16">
					<p-progressSpinner></p-progressSpinner>
					<span class="ml-3 text-gray-600">Loading screenings...</span>
				</div>

				<!-- Screenings List -->
				<div *ngIf="!loading && screenings.length > 0" class="space-y-4">
					<div
						*ngFor="let screening of screenings"
						class="border border-gray-200 rounded-lg p-4 hover:border-blue-500 cursor-pointer transition-colors duration-200"
						[class.border-blue-500]="selectedScreening?.id === screening.id"
						[class.bg-blue-50]="selectedScreening?.id === screening.id"
						(click)="selectScreening(screening)"
					>
						<div class="flex items-start gap-4">
							<!-- Movie Poster -->
							<div class="flex-shrink-0">
								<img
									*ngIf="
										getFirstPortraitImage(screening.movie!);
										else moviePlaceholder
									"
									[src]="
										getMediaUrl(getFirstPortraitImage(screening.movie!).uri)
									"
									[alt]="screening.movie.name"
									class="w-16 h-24 object-cover rounded-lg shadow-sm"
								/>
								<ng-template #moviePlaceholder>
									<div
										class="w-16 h-24 bg-gray-200 rounded-lg flex items-center justify-center"
									>
										<i class="pi pi-image text-gray-400 text-xl"></i>
									</div>
								</ng-template>
							</div>

							<!-- Screening Details -->
							<div class="flex-1">
								<div class="flex justify-between items-start mb-2">
									<h3 class="text-lg font-semibold text-gray-900">
										{{ screening.movie.name }}
									</h3>
									<p-tag
										[value]="screening.movie.durationMin + ' min'"
										severity="info"
									></p-tag>
								</div>

								<div
									class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600"
								>
									<div class="space-y-2">
										<div class="flex items-center gap-2">
											<i class="pi pi-building text-blue-600"></i>
											<span>{{ screening.hall.theatre.name }}</span>
										</div>
										<div class="flex items-center gap-2">
											<i class="pi pi-home text-blue-600"></i>
											<span>{{ screening.hall.name }}</span>
										</div>
									</div>
									<div class="space-y-2">
										<div class="flex items-center gap-2">
											<i class="pi pi-calendar text-blue-600"></i>
											<span>{{ formatDate(screening.date) }}</span>
										</div>
										<div class="flex items-center gap-2">
											<i class="pi pi-clock text-blue-600"></i>
											<span>{{ formatTime(screening.startTime) }}</span>
										</div>
									</div>
								</div>

								<!-- Seat Prices -->
								<div class="mt-3">
									<div class="flex flex-wrap gap-2">
										<div
											*ngFor="let price of screening.screeningSeatPrices"
											class="px-3 py-1 bg-gray-100 rounded-full text-xs"
										>
											{{ price.seatCategory?.name }}: Nu. {{ price.price }}
										</div>
									</div>
								</div>
							</div>

							<!-- Selection Indicator -->
							<div
								*ngIf="selectedScreening?.id === screening.id"
								class="flex-shrink-0"
							>
								<div
									class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center"
								>
									<i class="pi pi-check text-white text-sm"></i>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Empty State -->
				<div
					*ngIf="!loading && screenings.length === 0"
					class="text-center py-16"
				>
					<div class="text-gray-400 mb-4">
						<i class="pi pi-calendar text-6xl"></i>
					</div>
					<h3 class="text-lg font-medium text-gray-900 mb-2">
						No Screenings Available
					</h3>
					<p class="text-gray-600">
						No screenings match your current filters or there are no upcoming
						screenings.
					</p>
				</div>

				<!-- Step Actions -->
				<div class="flex justify-end pt-6 border-t border-gray-200">
					<p-button
						label="Next: Select Seats"
						icon="pi pi-arrow-right"
						iconPos="right"
						[disabled]="!canProceedToNextStep()"
						(onClick)="nextStep()"
					></p-button>
				</div>
			</div>

			<!-- Step 2: Select Seats -->
			<div *ngIf="currentStep === 2" class="space-y-6">
				<div class="flex items-center gap-3 mb-6">
					<div
						class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"
					>
						<i class="pi pi-th-large text-blue-600 text-xl"></i>
					</div>
					<div>
						<h2 class="text-xl font-semibold text-gray-900">Select Seats</h2>
						<p class="text-gray-600">Choose available seats for the booking</p>
					</div>
				</div>

				<!-- Selected Screening Info -->
				<div
					*ngIf="selectedScreening"
					class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6"
				>
					<div class="flex items-center gap-4">
						<img
							*ngIf="
								getFirstPortraitImage(selectedScreening.movie!);
								else moviePlaceholder
							"
							[src]="
								getMediaUrl(getFirstPortraitImage(selectedScreening.movie!).uri)
							"
							[alt]="selectedScreening.movie.name"
							class="w-12 h-16 object-cover rounded shadow-sm"
						/>
						<ng-template #moviePlaceholder>
							<div
								class="w-12 h-16 bg-gray-200 rounded flex items-center justify-center"
							>
								<i class="pi pi-image text-gray-400"></i>
							</div>
						</ng-template>
						<div>
							<h3 class="font-semibold text-gray-900">
								{{ selectedScreening.movie.name }}
							</h3>
							<p class="text-sm text-gray-600">
								{{ selectedScreening.hall.theatre.name }} -
								{{ selectedScreening.hall.name }}
							</p>
							<p class="text-sm text-gray-600">
								{{ formatDate(selectedScreening.date) }} at
								{{ formatTime(selectedScreening.startTime) }}
							</p>
						</div>
					</div>
				</div>

				<!-- Seat Selection Component -->
				<!-- <app-admin-seat-selection
					*ngIf="selectedScreening"
					[screeningId]="selectedScreening.id"
					(seatsSelected)="onSeatsSelected($event)"
					(totalAmountChange)="onTotalAmountChange($event)"
				></app-admin-seat-selection> -->

				<!-- Empty State -->
				<div *ngIf="!selectedScreening" class="text-center py-16">
					<div class="text-gray-400 mb-4">
						<i class="pi pi-th-large text-6xl"></i>
					</div>
					<h3 class="text-lg font-medium text-gray-900 mb-2">
						No Screening Selected
					</h3>
					<p class="text-gray-600">
						Please select a screening to view available seats.
					</p>
				</div>

				<!-- Step Actions -->
				<div class="flex justify-between pt-6 border-t border-gray-200">
					<p-button
						label="Previous"
						icon="pi pi-arrow-left"
						severity="secondary"
						[outlined]="true"
						(onClick)="previousStep()"
					></p-button>
					<p-button
						label="Next: Customer Details"
						icon="pi pi-arrow-right"
						iconPos="right"
						[disabled]="!canProceedToNextStep()"
						(onClick)="proceedToCustomerDetails()"
					></p-button>
				</div>
			</div>

			<!-- Step 3: Customer Details -->
			<div *ngIf="currentStep === 3" class="space-y-6">
				<div class="flex items-center gap-3 mb-6">
					<div
						class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"
					>
						<i class="pi pi-user text-blue-600 text-xl"></i>
					</div>
					<div>
						<h2 class="text-xl font-semibold text-gray-900">
							Customer Details
						</h2>
						<p class="text-gray-600">Enter customer information</p>
					</div>
				</div>

				<!-- Customer Form -->
				<form [formGroup]="customerForm" class="space-y-6">
					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<!-- Customer Name -->
						<div class="field">
							<label
								for="customerName"
								class="block text-sm font-medium text-gray-700 mb-2"
							>
								Customer Name *
							</label>
							<input
								id="customerName"
								type="text"
								pInputText
								formControlName="customerName"
								placeholder="Enter customer name"
								class="w-full"
								[class.ng-invalid]="
									isFieldInvalid(customerForm, 'customerName')
								"
							/>
							<small
								class="p-error"
								*ngIf="isFieldInvalid(customerForm, 'customerName')"
							>
								{{ getFieldError(customerForm, "customerName") }}
							</small>
						</div>

						<!-- Phone Number -->
						<div class="field">
							<label
								for="phoneNumber"
								class="block text-sm font-medium text-gray-700 mb-2"
							>
								Phone Number *
							</label>
							<input
								id="phoneNumber"
								type="tel"
								pInputText
								formControlName="phoneNumber"
								placeholder="Enter 8-digit phone number"
								maxlength="8"
								class="w-full"
								[class.ng-invalid]="isFieldInvalid(customerForm, 'phoneNumber')"
							/>
							<small
								class="p-error"
								*ngIf="isFieldInvalid(customerForm, 'phoneNumber')"
							>
								{{ getFieldError(customerForm, "phoneNumber") }}
							</small>
						</div>

						<!-- Email -->
						<div class="field">
							<label
								for="email"
								class="block text-sm font-medium text-gray-700 mb-2"
							>
								Email Address
							</label>
							<input
								id="email"
								type="email"
								pInputText
								formControlName="email"
								placeholder="Enter email address (optional)"
								class="w-full"
								[class.ng-invalid]="isFieldInvalid(customerForm, 'email')"
							/>
							<small
								class="p-error"
								*ngIf="isFieldInvalid(customerForm, 'email')"
							>
								{{ getFieldError(customerForm, "email") }}
							</small>
						</div>

						<!-- Payment Method -->
						<div class="field">
							<label
								for="paymentMethod"
								class="block text-sm font-medium text-gray-700 mb-2"
							>
								Payment Method *
							</label>
							<p-dropdown
								[options]="[
									{ label: 'Cash', value: 'CASH' },
									{ label: 'Card', value: 'CARD' },
									{ label: 'Digital Wallet', value: 'DIGITAL_WALLET' }
								]"
								formControlName="paymentMethod"
								optionLabel="label"
								optionValue="value"
								placeholder="Select payment method"
								class="w-full"
							></p-dropdown>
						</div>
					</div>

					<!-- Notes -->
					<div class="field">
						<label
							for="notes"
							class="block text-sm font-medium text-gray-700 mb-2"
						>
							Notes
						</label>
						<textarea
							id="notes"
							pInputTextarea
							formControlName="notes"
							placeholder="Additional notes (optional)"
							rows="3"
							class="w-full"
						></textarea>
					</div>

					<!-- Booking Status -->
					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<div class="field">
							<label
								for="bookingStatus"
								class="block text-sm font-medium text-gray-700 mb-2"
							>
								Booking Status *
							</label>
							<p-dropdown
								[options]="[
									{ label: 'Success', value: BookingStatusEnum.CONFIRMED }
								]"
								formControlName="bookingStatus"
								optionLabel="label"
								optionValue="value"
								placeholder="Select booking status"
								class="w-full"
							></p-dropdown>
						</div>

						<div class="field">
							<label
								for="entryStatus"
								class="block text-sm font-medium text-gray-700 mb-2"
							>
								Entry Status *
							</label>
							<p-dropdown
								[options]="[
									{ label: 'Valid', value: EntryStatusEnum.VALID },
									{ label: 'Entered', value: EntryStatusEnum.ENTERED }
								]"
								formControlName="entryStatus"
								optionLabel="label"
								optionValue="value"
								placeholder="Select entry status"
								class="w-full"
							></p-dropdown>
						</div>
					</div>
				</form>

				<!-- Step Actions -->
				<div class="flex justify-between pt-6 border-t border-gray-200">
					<p-button
						label="Previous"
						icon="pi pi-arrow-left"
						severity="secondary"
						[outlined]="true"
						(onClick)="previousStep()"
					></p-button>
					<p-button
						label="Next: Review & Book"
						icon="pi pi-arrow-right"
						iconPos="right"
						[disabled]="!canProceedToNextStep()"
						(onClick)="proceedToReview()"
					></p-button>
				</div>
			</div>

			<!-- Step 4: Review & Book -->
			<div *ngIf="currentStep === 4" class="space-y-6">
				<div class="flex items-center gap-3 mb-6">
					<div
						class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"
					>
						<i class="pi pi-check-circle text-blue-600 text-xl"></i>
					</div>
					<div>
						<h2 class="text-xl font-semibold text-gray-900">Review & Book</h2>
						<p class="text-gray-600">Confirm booking details</p>
					</div>
				</div>

				<!-- Booking Summary -->
				<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
					<!-- Movie & Screening Details -->
					<p-card styleClass="h-fit">
						<ng-template pTemplate="header">
							<div class="p-4 border-b">
								<h3 class="text-lg font-semibold text-gray-900">
									Screening Details
								</h3>
							</div>
						</ng-template>

						<div class="space-y-4" *ngIf="selectedScreening">
							<div class="flex items-start gap-4">
								<img
									*ngIf="
										getFirstPortraitImage(selectedScreening.movie!);
										else moviePlaceholder
									"
									[src]="
										getMediaUrl(
											getFirstPortraitImage(selectedScreening.movie!).uri
										)
									"
									[alt]="selectedScreening.movie.name"
									class="w-16 h-24 object-cover rounded-lg shadow-sm"
								/>
								<ng-template #moviePlaceholder>
									<div
										class="w-16 h-24 bg-gray-200 rounded-lg flex items-center justify-center"
									>
										<i class="pi pi-image text-gray-400 text-xl"></i>
									</div>
								</ng-template>
								<div>
									<h4 class="text-lg font-semibold text-gray-900">
										{{ selectedScreening.movie.name }}
									</h4>
									<p class="text-sm text-gray-600 mb-2">
										{{ selectedScreening.movie.durationMin }} min
									</p>
									<div class="space-y-1 text-sm text-gray-600">
										<p>
											<i class="pi pi-building mr-2"></i>
											{{ selectedScreening.hall.theatre.name }}
										</p>
										<p>
											<i class="pi pi-home mr-2"></i>
											{{ selectedScreening.hall.name }}
										</p>
										<p>
											<i class="pi pi-calendar mr-2"></i>
											{{ formatDate(selectedScreening.date) }}
										</p>
										<p>
											<i class="pi pi-clock mr-2"></i>
											{{ formatTime(selectedScreening.startTime) }}
										</p>
									</div>
								</div>
							</div>
						</div>
					</p-card>

					<!-- Customer Details -->
					<p-card styleClass="h-fit">
						<ng-template pTemplate="header">
							<div class="p-4 border-b">
								<h3 class="text-lg font-semibold text-gray-900">
									Customer Details
								</h3>
							</div>
						</ng-template>

						<div class="space-y-3">
							<div class="flex justify-between">
								<span class="text-gray-600">Name:</span>
								<span class="font-medium">{{
									customerForm.get("customerName")?.value
								}}</span>
							</div>
							<div class="flex justify-between">
								<span class="text-gray-600">Phone:</span>
								<span class="font-medium">{{
									customerForm.get("phoneNumber")?.value
								}}</span>
							</div>
							<div
								class="flex justify-between"
								*ngIf="customerForm.get('email')?.value"
							>
								<span class="text-gray-600">Email:</span>
								<span class="font-medium">{{
									customerForm.get("email")?.value
								}}</span>
							</div>
							<div class="flex justify-between">
								<span class="text-gray-600">Payment:</span>
								<span class="font-medium">{{
									customerForm.get("paymentMethod")?.value
								}}</span>
							</div>
							<div
								class="flex justify-between"
								*ngIf="customerForm.get('notes')?.value"
							>
								<span class="text-gray-600">Notes:</span>
								<span class="font-medium">{{
									customerForm.get("notes")?.value
								}}</span>
							</div>
						</div>
					</p-card>
				</div>

				<!-- Selected Seats -->
				<p-card>
					<ng-template pTemplate="header">
						<div class="p-4 border-b">
							<h3 class="text-lg font-semibold text-gray-900">
								Selected Seats ({{ selectedSeats.length }})
							</h3>
						</div>
					</ng-template>

					<div class="space-y-4">
						<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
							<div
								*ngFor="let seat of selectedSeats"
								class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"
							>
								<div>
									<p class="font-medium">{{ seat.seatNumber }}</p>
									<p class="text-sm text-gray-600">
										{{ seat.category?.name }}
									</p>
								</div>
								<p class="font-semibold">Nu. {{ seat.price }}</p>
							</div>
						</div>

						<div
							class="flex justify-between items-center pt-4 border-t border-gray-200"
						>
							<span class="text-lg font-semibold">Total Amount:</span>
							<span class="text-2xl font-bold text-blue-600">
								Nu. {{ getTotalAmount() }}
							</span>
						</div>
					</div>
				</p-card>

				<!-- Step Actions -->
				<div class="flex justify-between pt-6 border-t border-gray-200">
					<p-button
						label="Previous"
						icon="pi pi-arrow-left"
						severity="secondary"
						[outlined]="true"
						(onClick)="previousStep()"
					></p-button>
					<p-button
						label="Create Booking"
						icon="pi pi-check"
						[loading]="isSubmitting"
						(onClick)="submitBooking()"
						styleClass="px-8"
					></p-button>
				</div>
			</div>
		</p-card>
	</div>
</div>
