<p-toast position="top-right"></p-toast>

<div class="min-h-screen bg-gray-50 py-6 px-4">
	<div class="mx-auto max-w-7xl">
		<!-- Header -->
		<div class="mb-8">
			<h1 class="text-3xl font-bold text-gray-900 mb-2">
				Counter Ticket Sales
			</h1>
			<p>Complete ticket booking process for walk-in customers</p>
		</div>

		<!-- Step 1: Movie Selection -->
		<div *ngIf="currentStep === 'movie-selection'">
			<div class="mb-6">
				<h2 class="text-2xl font-bold text-gray-900 mb-2">Select Movie</h2>
				<p class="text-gray-600">Choose a movie for booking</p>
			</div>

			<!-- Search -->
			<div class="mb-6">
				<div class="relative">
					<input
						type="text"
						[(ngModel)]="movieSearchTerm"
						(ngModelChange)="filterMovies()"
						placeholder="Search movies..."
						class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
					/>
					<i
						class="pi pi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
					></i>
				</div>
			</div>

			<!-- Loading State -->
			<div *ngIf="loading" class="flex justify-center items-center py-16">
				<p-progressSpinner strokeWidth="3"></p-progressSpinner>
				<span class="ml-3 text-gray-600">Loading movies...</span>
			</div>

			<!-- Movies Grid -->
			<div
				*ngIf="!loading"
				class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
			>
				<div
					*ngFor="let movie of filteredMovies"
					class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow cursor-pointer"
					(click)="selectMovie(movie)"
				>
					<div class="aspect-w-2 aspect-h-3 bg-gray-200">
						<img
							[src]="getPosterUrl(movie)"
							[alt]="movie.name"
							class="w-full h-64 object-cover"
							onerror="this.src='assets/images/default-poster.jpg'"
						/>
					</div>
					<div class="p-4">
						<h3 class="font-semibold text-gray-900 mb-2">{{ movie.name }}</h3>
						<div class="text-sm text-gray-600 space-y-1">
							<p *ngIf="movie.durationMin">
								<i class="pi pi-clock mr-1"></i>
								{{ movie.durationMin }} min
							</p>
							<p *ngIf="movie.pgRating">
								<i class="pi pi-star mr-1"></i>
								{{ movie.pgRating }}
							</p>
							<p *ngIf="movie.genres && movie.genres.length > 0">
								<i class="pi pi-tag mr-1"></i>
								<span *ngFor="let genre of movie.genres; let last = last">
									{{ genre.name }}<span *ngIf="!last">, </span>
								</span>
							</p>
						</div>
					</div>
				</div>
			</div>

			<!-- Empty State -->
			<div
				*ngIf="!loading && filteredMovies.length === 0"
				class="text-center py-16"
			>
				<i class="pi pi-video text-gray-400 text-6xl mb-4"></i>
				<h3 class="text-lg font-medium text-gray-900 mb-2">No Movies Found</h3>
				<p class="text-gray-600">
					{{
						movieSearchTerm
							? "Try adjusting your search terms"
							: "No movies available for booking"
					}}
				</p>
			</div>
		</div>

		<!-- Step 2: Screening Selection -->
		<div *ngIf="currentStep === 'screening-selection' && selectedMovie">
			<div class="mb-6">
				<button
					type="button"
					class="inline-flex items-center text-blue-600 hover:text-blue-700 mb-4"
					(click)="backToMovieSelection()"
				>
					<i class="pi pi-arrow-left mr-2"></i>
					Back to Movies
				</button>
				<h2 class="text-2xl font-bold text-gray-900 mb-2">Select Screening</h2>
				<p class="text-gray-600">
					Choose a screening time for {{ selectedMovie.name }}
				</p>
			</div>

			<!-- Selected Movie Info -->
			<div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
				<div class="flex items-center space-x-4">
					<img
						[src]="getPosterUrl(selectedMovie)"
						[alt]="selectedMovie.name"
						class="w-16 h-24 object-cover rounded"
						onerror="this.src='assets/images/default-poster.jpg'"
					/>
					<div>
						<h3 class="text-lg font-semibold text-blue-900">
							{{ selectedMovie.name }}
						</h3>
						<div class="text-sm text-blue-700 space-y-1">
							<p *ngIf="selectedMovie.durationMin">
								Duration: {{ selectedMovie.durationMin }} minutes
							</p>
							<p *ngIf="selectedMovie.pgRating">
								Rating: {{ selectedMovie.pgRating }}
							</p>
						</div>
					</div>
				</div>
			</div>

			<!-- Loading State -->
			<div
				*ngIf="loadingSchedules"
				class="flex justify-center items-center py-16"
			>
				<p-progressSpinner strokeWidth="3"></p-progressSpinner>
				<span class="ml-3 text-gray-600">Loading screenings...</span>
			</div>

			<!-- Screenings List -->
			<div *ngIf="!loadingSchedules" class="space-y-4">
				<div
					*ngFor="let screening of screenings"
					class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer border-l-4 border-blue-500"
					(click)="selectScreening(screening)"
				>
					<div class="flex justify-between items-start">
						<div class="flex-1">
							<div class="flex items-center space-x-4 mb-2">
								<h3 class="text-lg font-semibold text-gray-900">
									{{ formatScreeningDate(screening) }}
								</h3>
								<span
									class="px-3 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full"
								>
									{{ formatScreeningTime(screening) }}
								</span>
							</div>
							<div class="text-sm text-gray-600 space-y-1">
								<p>
									<i class="pi pi-building mr-2"></i>
									Theatre: {{ screening.hall.theatre.name || "N/A" }}
								</p>
								<p>
									<i class="pi pi-th-large mr-2"></i>
									Hall: {{ screening.hall.name || "N/A" }}
								</p>
								<p *ngIf="screening.audioLanguage?.name">
									<i class="pi pi-volume-up mr-2"></i>
									Audio: {{ screening.audioLanguage?.name }}
								</p>
								<p *ngIf="screening.subtitleLanguage?.name">
									<i class="pi pi-bookmark mr-2"></i>
									Subtitles: {{ screening.subtitleLanguage?.name }}
								</p>
							</div>
						</div>
						<div class="text-right">
							<button
								type="button"
								class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
								(click)="selectScreening(screening); $event.stopPropagation()"
							>
								Select
								<i class="pi pi-arrow-right ml-2"></i>
							</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Empty State -->
			<div
				*ngIf="!loadingSchedules && screenings.length === 0"
				class="text-center py-16"
			>
				<i class="pi pi-calendar text-gray-400 text-6xl mb-4"></i>
				<h3 class="text-lg font-medium text-gray-900 mb-2">
					No Screenings Available
				</h3>
				<p class="text-gray-600">
					There are no available screenings for this movie.
				</p>
			</div>
		</div>

		<!-- Step 3: Booking (Seat Selection Component) -->
		<div *ngIf="currentStep === 'booking' && selectedScreening">
			<div class="mb-6">
				<button
					type="button"
					class="inline-flex items-center text-blue-600 hover:text-blue-700 mb-4"
					(click)="backToScreeningSelection()"
				>
					<i class="pi pi-arrow-left mr-2"></i>
					Back to Screenings
				</button>
			</div>

			<!-- Self-contained Seat Selection Component -->
			<app-seat-selection
				[screeningId]="selectedScreening.id"
			></app-seat-selection>
		</div>
	</div>
</div>
