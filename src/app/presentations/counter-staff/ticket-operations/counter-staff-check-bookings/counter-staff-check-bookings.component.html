<p-toast position="top-right"></p-toast>

<div class="min-h-screen bg-gray-50 py-6 px-4">
	<div class="mx-auto max-w-7xl">
		<!-- Header -->
		<div class="mb-8">
			<h1 class="text-3xl font-bold text-gray-900 mb-2">Check Bookings</h1>
			<p class="text-gray-600">
				Search for customer bookings by phone number or email address
			</p>
		</div>

		<!-- Search Form -->
		<div class="mb-8 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
			<h2 class="text-xl font-semibold text-gray-900 mb-4">
				Search Customer Bookings
			</h2>

			<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
				<!-- Phone Number Search -->
				<div>
					<label
						for="phoneNumber"
						class="block text-sm font-medium text-gray-700 mb-2"
					>
						Phone Number
					</label>
					<input
						type="tel"
						id="phoneNumber"
						[(ngModel)]="searchPhoneNumber"
						placeholder="Enter phone number (e.g., 17123456)"
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
						[disabled]="loading"
					/>
				</div>

				<!-- Email Search -->
				<div>
					<label
						for="email"
						class="block text-sm font-medium text-gray-700 mb-2"
					>
						Email Address
					</label>
					<input
						type="email"
						id="email"
						[(ngModel)]="searchEmail"
						placeholder="Enter email address"
						class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
						[disabled]="loading"
					/>
				</div>
			</div>

			<!-- Search Actions -->
			<div class="flex justify-between items-center">
				<p class="text-sm text-gray-600">
					<i class="pi pi-info-circle mr-1"></i>
					Enter either phone number or email address to search
				</p>
				<div class="flex space-x-3">
					<button
						type="button"
						class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors"
						(click)="clearSearch()"
						[disabled]="loading"
					>
						<i class="pi pi-times mr-2"></i>
						Clear
					</button>
					<button
						type="button"
						class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
						(click)="searchBookings()"
						[disabled]="loading"
					>
						<p-progressSpinner
							*ngIf="loading"
							strokeWidth="3"
							[style]="{ width: '16px', height: '16px' }"
							class="mr-2"
						></p-progressSpinner>
						<i *ngIf="!loading" class="pi pi-search mr-2"></i>
						{{ loading ? "Searching..." : "Search Bookings" }}
					</button>
				</div>
			</div>
		</div>

		<!-- Search Results -->
		<div *ngIf="searchPerformed">
			<!-- Results Header -->
			<div class="mb-4">
				<div class="flex justify-between items-start mb-2">
					<h3 class="text-lg font-semibold text-gray-900">
						Search Results
						<span class="text-sm font-normal text-gray-600 ml-2">
							({{ filteredBookings.length }} of {{ bookings.length }} booking{{
								bookings.length !== 1 ? "s" : ""
							}}
							{{
								filteredBookings.length !== bookings.length ? "shown" : "found"
							}})
						</span>
					</h3>

					<!-- Filter Controls -->
					<div *ngIf="bookings.length > 0" class="flex items-center space-x-3">
						<label class="text-sm font-medium text-gray-700"
							>Filter by screening:</label
						>
						<select
							[(ngModel)]="screeningStatusFilter"
							(ngModelChange)="onFilterChange()"
							class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
						>
							<option value="all">All Screenings</option>
							<option value="valid">Valid Only</option>
							<option value="expired">Expired Only</option>
						</select>
					</div>
				</div>

				<!-- Screening Status Summary -->
				<div *ngIf="bookings.length > 0" class="flex space-x-4 text-sm">
					<span class="flex items-center">
						<i class="pi pi-check-circle text-green-500 mr-1"></i>
						<span class="text-green-700"
							>{{ getValidBookingsCount() }} Valid</span
						>
					</span>
					<span class="flex items-center">
						<i class="pi pi-exclamation-triangle text-red-500 mr-1"></i>
						<span class="text-red-700"
							>{{ getExpiredBookingsCount() }} Expired</span
						>
					</span>
				</div>
			</div>

			<!-- No Results -->
			<div
				*ngIf="bookings.length === 0 && !loading"
				class="text-center py-12 bg-white rounded-lg border border-gray-200"
			>
				<i class="pi pi-search text-gray-400 text-4xl mb-4"></i>
				<h3 class="text-lg font-medium text-gray-900 mb-2">
					No Bookings Found
				</h3>
				<p class="text-gray-600">
					No bookings were found for the provided search criteria.
				</p>
			</div>

			<!-- No Filtered Results -->
			<div
				*ngIf="bookings.length > 0 && filteredBookings.length === 0 && !loading"
				class="text-center py-12 bg-white rounded-lg border border-gray-200"
			>
				<i class="pi pi-filter text-gray-400 text-4xl mb-4"></i>
				<h3 class="text-lg font-medium text-gray-900 mb-2">
					No
					{{ screeningStatusFilter === "valid" ? "Valid" : "Expired" }} Bookings
				</h3>
				<p class="text-gray-600">
					No
					{{ screeningStatusFilter === "valid" ? "valid" : "expired" }}
					screenings found in the search results.
				</p>
			</div>

			<!-- Bookings List -->
			<div *ngIf="filteredBookings.length > 0" class="space-y-4">
				<div
					*ngFor="let booking of filteredBookings"
					class="bg-white rounded-lg border border-gray-200 shadow-sm p-6"
				>
					<div class="flex justify-between items-start mb-4">
						<div class="flex-1">
							<h4 class="text-lg font-semibold text-gray-900 mb-1">
								{{ booking.screening?.movie?.name }}
							</h4>
							<p class="text-sm text-gray-600">
								Booking ID: {{ booking.uuid }}
							</p>
						</div>
						<div class="flex space-x-2">
							<!-- Screening Status Badge -->
							<span
								class="px-3 py-1 rounded-full text-sm font-medium"
								[class]="getScreeningStatusClass(booking)"
							>
								{{ getScreeningStatusText(booking) }}
							</span>
							<!-- Booking Status Badge -->
							<span
								class="px-3 py-1 rounded-full text-sm font-medium"
								[class]="getStatusClass(booking.bookingStatus)"
							>
								{{ booking.bookingStatus }}
							</span>
						</div>
					</div>

					<div
						class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4"
					>
						<!-- Customer Information -->
						<div>
							<h5 class="text-sm font-medium text-gray-700 mb-2">
								Customer Details
							</h5>
							<div class="text-sm text-gray-600 space-y-1">
								<p>
									<i class="pi pi-user mr-2"></i>
									{{ booking.name }}
								</p>
								<p>
									<i class="pi pi-phone mr-2"></i>
									{{ booking.phoneNumber }}
								</p>
								<p *ngIf="booking.email">
									<i class="pi pi-envelope mr-2"></i>
									{{ booking.email }}
								</p>
							</div>
						</div>

						<!-- Screening Information -->
						<div>
							<h5
								class="text-sm font-medium text-gray-700 mb-2 flex items-center"
							>
								Screening Details
								<i
									class="ml-2 text-xs"
									[class]="
										isScreeningExpired(booking)
											? 'pi pi-exclamation-triangle text-red-500'
											: 'pi pi-check-circle text-green-500'
									"
									[title]="
										isScreeningExpired(booking)
											? 'Screening has expired'
											: 'Screening is still valid'
									"
								></i>
							</h5>
							<div class="text-sm text-gray-600 space-y-1">
								<p>
									<i class="pi pi-calendar mr-2"></i>
									{{ booking.screening?.date | date : "shortDate" }}
								</p>
								<p>
									<i class="pi pi-clock mr-2"></i>
									{{ booking.screening?.startTime }} -
									{{ booking.screening?.endTime }}
									<span
										class="ml-2 px-2 py-1 text-xs rounded-full"
										[class]="getScreeningStatusClass(booking)"
									>
										{{ getScreeningStatusText(booking) }}
									</span>
								</p>
								<p>
									<i class="pi pi-building mr-2"></i>
									{{ booking.screening?.hall?.theatre?.name }}
								</p>
								<p>
									<i class="pi pi-th-large mr-2"></i>
									Hall: {{ booking.screening?.hall?.name }}
								</p>
							</div>
						</div>

						<!-- Booking Information -->
						<div>
							<h5 class="text-sm font-medium text-gray-700 mb-2">
								Booking Details
							</h5>
							<div class="text-sm text-gray-600 space-y-1">
								<p>
									<i class="pi pi-ticket mr-2"></i>
									Seats: {{ getBookingSeatsText(booking) }}
								</p>
								<p>
									<i class="pi pi-money-bill mr-2"></i>
									Amount: {{ formatCurrency(booking.amount || 0) }}
								</p>
								<p>
									<i class="pi pi-calendar-plus mr-2"></i>
									Booked: {{ booking.createdAt | date : "medium" }}
								</p>
							</div>
						</div>
					</div>

					<!-- Booking Actions -->
					<div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
						<button
							type="button"
							class="px-4 py-2 text-blue-600 hover:text-blue-700 text-sm font-medium"
							(click)="viewTicket(booking)"
						>
							<i class="pi pi-eye mr-1"></i>
							View Ticket
						</button>
						<!-- Resend eTicket button, only for valid screenings -->
						<button
							type="button"
							class="px-4 py-2 text-green-600 hover:text-green-700 text-sm font-medium"
							*ngIf="getScreeningStatusText(booking) === 'Valid'"
							(click)="resendETicket(booking)"
							[disabled]="resendingETicketId === booking.id"
						>
							<i class="pi pi-send mr-1"></i>
							<span *ngIf="resendingETicketId !== booking.id"
								>Resend eTicket</span
							>
							<p-progressSpinner
								*ngIf="resendingETicketId === booking.id"
								strokeWidth="3"
								[style]="{ width: '16px', height: '16px' }"
								class="ml-2"
							></p-progressSpinner>
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
